<h1 class="card-header">
  Edit Mission Steps <button mat-raised-button color="primary" type="button" (click)="addStep()">Add Step</button>
</h1>

<form [formGroup]="stepForm">
    <div class="prelim-wrapper">
      <mat-accordion [multi]="true" class="prelim-steps" cdkDropList (cdkDropListDropped)="drop($event)">
        <mat-expansion-panel class="step" cdkDrag *ngFor="let step of mission.steps; let i = index">
          <mat-expansion-panel-header>
            <mat-icon cdkDragHandle>reorder</mat-icon>
            <span class="step-num"><b>Step {{i + 1}}: </b></span>
            <span class="step-name">{{step.displayName}}</span>
            <span class="step-count"><b>Count:</b> {{step.count}}</span>
          </mat-expansion-panel-header>

          <div class="form-row">
            <mat-form-field>
              <input matInput placeholder="Display name" name="displayName" formControlName="displayName{{i}}" value="{{step.displayName}}">
            </mat-form-field>
            <mat-form-field>
              <input matInput placeholder="Count" name="count" formControlName="count{{i}}" value="{{step.count}}">
            </mat-form-field>
          </div>
          <div class="form-row">
            <mat-form-field>
              <input matInput placeholder="Description" name="description" formControlName="description{{i}}" value="{{step.description}}">
            </mat-form-field>
          </div>

          <h1>Edit Step Rewards</h1>

          <div class="reward-row" *ngFor="let reward of step.rewards; let rewardIndex = index">
            <mat-form-field>
              <input matInput placeholder="Reward Item" name="step{{i}}Reward{{rewardIndex}}Item" formControlName="step{{i}}Reward{{rewardIndex}}Item" value="{{reward.item.name}}">
            </mat-form-field>
            <mat-form-field>
              <input matInput placeholder="Reward Quantity" name="step{{i}}Reward{{rewardIndex}}Ct" formControlName="step{{i}}Reward{{rewardIndex}}Ct" value="{{reward.quantity}}">
            </mat-form-field>
            <button type="button" mat-raised-button color="primary">-</button>
          </div>
          <div class="reward-row-row">
            <mat-form-field>
              <input matInput #newRewardItem placeholder="Reward Item" name="newRewardItem" formControlName="step{{i}}NewRewardItem">
            </mat-form-field>
            <mat-form-field class="no-margin">
              <input matInput #newRewardCt placeholder="Reward Quantity" name="newRewardCt" formControlName="step{{i}}NewRewardCt">
            </mat-form-field>
            <button mat-raised-button color="primary" class="add-reward-button" type="button">+</button>
          </div>

          <app-json-editor-card [topic]="Step" [editTarget]="step.metadata || {}"></app-json-editor-card>
        </mat-expansion-panel>

        <mat-expansion-panel class="new-step no-drag step">
          <mat-expansion-panel-header>
            <span class="step-num"><b>New Step</b></span>
            <span class="step-name"></span>
            <span class="step-count"><b>Count:</b> 0</span>
          </mat-expansion-panel-header>

          <div class="form-row">
            <mat-form-field>
              <input matInput placeholder="Display name" name="newDisplayName" formControlName="newDisplayName">
            </mat-form-field>
            <mat-form-field>
              <input matInput placeholder="Count" name="newCount" formControlName="newCount">
            </mat-form-field>
          </div>
          <div class="form-row">
            <mat-form-field>
              <input matInput placeholder="Description" name="newDescription" formControlName="newDescription">
            </mat-form-field>
          </div>

          <h1>Edit Step Rewards</h1>

          <div class="reward-row" *ngFor="let reward of newStep.rewards; let rewardIndex = index">
            <mat-form-field>
              <input matInput placeholder="Reward Item" name="newStepReward{{rewardIndex}}Item" formControlName="newStepReward{{rewardIndex}}Item" value="{{reward.item.name}}">
            </mat-form-field>
            <mat-form-field>
              <input matInput placeholder="Reward Quantity" name="newStepReward{{rewardIndex}}Ct" formControlName="newStepReward{{rewardIndex}}Ct" value="{{reward.quantity}}">
            </mat-form-field>
            <button type="button" mat-raised-button color="primary">-</button>
          </div>
          <div class="reward-row">
            <mat-form-field>
              <input matInput #newRewardItem placeholder="Reward Item" name="newRewardItem" formControlName="newStepNewRewardItem">
            </mat-form-field>
            <mat-form-field class="no-margin">
              <input matInput #newRewardCt placeholder="Reward Quantity" name="newRewardCt" formControlName="newStepNewRewardCt">
            </mat-form-field>
            <button mat-raised-button color="primary" class="add-reward-button" type="button">+</button>
          </div>

          <app-json-editor-card [topic]="Step" [editTarget]="newStep.metadata || {}"></app-json-editor-card>

          <mat-action-row>
            <button mat-button>Cancel</button>
            <button mat-raised-button color="primary">Add</button>
          </mat-action-row>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
    <mat-accordion>
      <mat-expansion-panel class="no-drag">
        <mat-expansion-panel-header>
          <span class="step-num"><b>Repeat Step:</b></span>

          <span class="step-name"  *ngIf="mission.finalRepeatStep">{{mission.finalRepeatStep.displayName}}</span>
          <span class="step-name" *ngIf="!mission.finalRepeatStep">N/A</span>

          <span class="step-count">
          <b>Count:</b>
          <span *ngIf="mission.finalRepeatStep">{{mission.finalRepeatStep.count}}</span>
          <span *ngIf="!mission.finalRepeatStep">N/A</span>
        </span>
        </mat-expansion-panel-header>
      </mat-expansion-panel>
    </mat-accordion>
</form>
